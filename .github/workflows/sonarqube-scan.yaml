name: ðŸ“Š SonarQube Code Analysis

on:
  push:
    branches:
      - main
      - develop
      - staging
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      fail-on-quality-gate:
        description: 'Falhar se Quality Gate nÃ£o passar'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  sonarqube-analysis:
    name: ðŸ“Š AnÃ¡lise de CÃ³digo Python
    uses: 77Negativo/core-action-sec/.github/workflows/sonarqube-analysis.yaml@main
    with:
      # ConfiguraÃ§Ãµes especÃ­ficas do projeto Dashboard Python
      project-key: 'dashboard-owasp-top10-2025'
      project-name: 'Dashboard OWASP Top 10 2025 - SonarQube'
      sources: '.'
      exclusions: |
        **/__pycache__/**,
        **/*.pyc,
        **/.pytest_cache/**,
        **/venv/**,
        **/env/**,
        **/.git/**,
        **/.github/**,
        **/sonarqube_scans_history/**,
        **/sonarqube_dashboard.html

      # ConfiguraÃ§Ãµes de anÃ¡lise
      fail-on-quality-gate: ${{ github.event.inputs.fail-on-quality-gate || false }}
      quality-gate-wait: true
      skip-java-setup: true

    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

  # Job para mostrar resultados
  display-results:
    name: ðŸ“‹ Exibir Resultados
    needs: sonarqube-analysis
    runs-on: k8s-onprem-runners  # âš ï¸ PADRÃƒO OBRIGATÃ“RIO - NUNCA ALTERAR
    if: always()
    steps:
      - name: ðŸ“Š Resumo da AnÃ¡lise
        run: |
          echo "### ðŸ“Š Resultados da AnÃ¡lise SonarQube" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Projeto**: Dashboard OWASP Top 10 2025" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ needs.sonarqube-analysis.outputs.environment-name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Quality Gate**: ${{ needs.sonarqube-analysis.outputs.quality-gate-status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **[Ver Dashboard Completo](${{ needs.sonarqube-analysis.outputs.project-url }})**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Status visual
          STATUS="${{ needs.sonarqube-analysis.outputs.quality-gate-status }}"
          case "$STATUS" in
            "OK")
              echo "âœ… **Status**: AnÃ¡lise concluÃ­da com sucesso! CÃ³digo dentro dos padrÃµes de qualidade." >> $GITHUB_STEP_SUMMARY
              ;;
            "ERROR")
              echo "âŒ **Status**: Quality Gate falhou! Revise os problemas identificados no dashboard." >> $GITHUB_STEP_SUMMARY
              ;;
            "WARN")
              echo "âš ï¸ **Status**: AnÃ¡lise concluÃ­da com avisos. Verifique os detalhes no dashboard." >> $GITHUB_STEP_SUMMARY
              ;;
            *)
              echo "â„¹ï¸ **Status**: $STATUS" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
